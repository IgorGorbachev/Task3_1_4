<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AdminPanel</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
        }

        .main-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: 60px;
            background-color: #212529;
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            z-index: 1000;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .header-title {
            font-size: 1.2rem;
            font-weight: 500;
            margin-left: 10px;
        }

        .logout-btn {
            background-color: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background-color: #bb2d3b;
        }

        .sidebar {
            height: calc(100vh - 60px);
            width: 200px;
            position: fixed;
            left: 0;
            top: 60px;
            z-index: 100;
            background: #ffffff;
            /*color: white;*/
            transition: all 0.3s;
            border-right: 1px solid #dee2e6;
        }

        .sidebar ul.components {
            padding: 20px 0;
        }

        .sidebar ul li a {
            padding: 10px;
            display: block;
            color: #0a58ca;
            text-decoration: none;
        }

        .sidebar ul li a:hover {
            color: white;
            background: #0d6efd;
        }

        .sidebar ul li a i {
            margin-right: 10px;
        }

        .main-content {
            margin-left: 220px;
            padding: 70px;
        }

        .nav-tabs {
            margin-bottom: 10px;
            background-color: white;
            padding: 10px 15px;
            border-radius: 5px 5px 0 0;
            box-shadow: none;
            border-bottom: 1px solid #dee2e6;
        }

        .tab-content {
            padding: 20px;
        }

        .table-container {
            margin-top: 30px;
        }

        .table {
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        .table thead {
            background-color: #f8f9fa;
        }

        .table-title {
            margin-bottom: 15px;
            font-weight: 500;
            color: #212529;
        }

        .form-container {
            max-width: 600px;
            margin: 0 auto;
        }

        .form-title {
            margin-bottom: 25px;
            font-weight: 500;
            color: #212529;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .delete-user-modal .modal-body {
            padding: 20px;
        }

        .delete-user-modal .user-info {
            margin-bottom: 15px;
        }

        .delete-user-modal .user-info div {
            margin-bottom: 8px;
            padding: 5px;
            background-color: #f8f9fa;
            border-radius: 4px;
        }

    </style>
</head>
<body>
<header class="main-header">
    <div class="header-title">Admin with roles: ADMIN USER</div>
    <form id="logoutForm" method="post" action="/logout">
        <button type="submit" class="logout-btn">
            <i class="bi bi-box-arrow-right"></i> Logout
        </button>
    </form>
</header>
<div class="d-flex">
    <!-- Sidebar -->
    <nav id="sidebar" class="sidebar">
        <ul class="list-unstyled components">
            <li class="active">
                <a href="#" id="adminLink"><i class="bi bi-house-door"></i>Admin</a>
            </li>
            <li>
                <a href="#" id="userLink"><i class="bi bi-person"></i>User</a>
            </li>
        </ul>
    </nav>

    <!-- Main Content -->
    <div class="main-content flex-grow-1">
        <h2>Admin panel</h2>

        <div class="table-container">
            <ul class="nav nav-tabs" id="myTab" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="user-table-tab" data-bs-toggle="tab"
                            data-bs-target="#user-table" type="button" role="tab" aria-controls="user-table"
                            aria-selected="true">User table
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="new-user-tab" data-bs-toggle="tab" data-bs-target="#new-user"
                            type="button" role="tab" aria-controls="new-user" aria-selected="false">New User
                    </button>
                </li>
            </ul>

            <div class="tab-content">
                <div class="tab-pane fade show active" id="user-table" role="tabpanel" aria-labelledby="user-table-tab">
                    <h5 class="table-title">All users</h5>
                    <table class="table table-hover">
                        <thead>
                        <tr>
                            <th scope="col">ID</th>
                            <th scope="col">Имя</th>
                            <th scope="col">Возраст</th>
                            <th scope="col">Роль</th>
                            <th scope="col">Изменить</th>
                            <th scope="col">Удалить</th>
                        </tr>
                        </thead>
                        <tbody id="usersTableBody"></tbody>
                    </table>

                    <!-- Модальное окно удаления -->
                    <div class="modal fade" id="deleteUserModal" tabindex="-1" aria-labelledby="deleteUserModalLabel"
                         aria-modal="true">
                        <div class="modal-dialog" role="dialog">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h5 class="modal-title" id="deleteUserModalLabel">Delete user</h5>
                                    <button type="button" class="btn-close" data-bs-dismiss="modal"
                                            aria-label="Close"></button>
                                </div>
                                <div class="modal-body">
                                    <div class="user-info">
                                        <div><strong>ID:</strong> <span id="deleteUserId"></span></div>
                                        <div><strong>Name:</strong> <span id="deleteUserName"></span></div>
                                        <div><strong>Age:</strong> <span id="deleteUserAge"></span></div>
                                        <div><strong>Role:</strong> <span id="deleteUserRoles"></span></div>
                                    </div>
                                    <div class="alert alert-warning">
                                        Вы уверены, что хотите удалить этого пользователя? Это действие нельзя отменить.
                                    </div>
                                </div>
                                <div class="modal-footer">
                                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close
                                    </button>
                                    <button type="button" class="btn btn-danger" id="confirmDelete">Delete</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Форма добавления нового пользователя -->
                <div class="tab-pane fade" id="new-user" role="tabpanel" aria-labelledby="new-user-tab">
                    <div class="form-container">
                        <h5 class="form-title">Add new user</h5>
                        <form id="addUserForm">
                            <div class="form-group">
                                <label for="firstName" class="form-label">First name</label>
                                <input type="text" class="form-control" id="firstName" name="username" required>
                            </div>

                            <div class="form-group">
                                <label for="age" class="form-label">Age</label>
                                <input type="number" class="form-control" id="age" name="age" required>
                            </div>

                            <div class="form-group">
                                <label for="password" class="form-label">Password</label>
                                <input type="password" class="form-control" id="password" name="password" required>
                            </div>


                            <div class="form-group mb-3">
                                <label>Роли</label>
                                <select name="roles" id="rolesSelect" class="form-control" multiple>
                                    <option value="1">ADMIN</option>
                                    <option value="2">USER</option>
                                </select>
                            </div>

                            <button type="submit" class="btn btn-primary">Add new user</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно редактирования -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="editUserForm">
                <div class="modal-header">
                    <h5 class="modal-title" id="editUserModalLabel">Edit user</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editId" name="id">
                    <div class="form-group mb-3">
                        <label for="editFirstName" class="form-label">Name</label>
                        <input type="text" class="form-control" id="editFirstName" name="username" required>
                    </div>

                    <div class="form-group mb-3">
                        <label for="editAge" class="form-label">Age</label>
                        <input type="number" class="form-control" id="editAge" name="age" required>
                    </div>

                    <div class="form-group mb-3">
                        <label for="editPassword" class="form-label">Password</label>
                        <input type="password" class="form-control" id="editPassword"
                               placeholder="Leave blank to keep current" name="password">
                    </div>

                    <div class="form-group mb-3">
                        <label>Роли</label>
                        <select name="roles" id="editRolesSelect" class="form-control" multiple>
                            <option value="1">ADMIN</option>
                            <option value="2">USER</option>
                        </select>
                    </div>


                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="submit" class="btn btn-primary">Save changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {

        const deleteModal = new bootstrap.Modal(document.getElementById('deleteUserModal'));
        const editModal = new bootstrap.Modal(document.getElementById('editUserModal'));


        loadUsers();


        $('#addUserForm').on('submit', function (e) {
            e.preventDefault();
            addUser();
        });


        $('#editUserForm').on('submit', function (e) {
            e.preventDefault();
            updateUser();
        });


        $('#confirmDelete').on('click', deleteUser);


        function loadUsers() {
            fetch('/api/admins/')
                .then(response => response.json())
                .then(users => {
                    const tableBody = $('#usersTableBody');
                    tableBody.empty();

                    users.forEach(user => {
                        const roles = user.roles.map(role =>
                            `<span class="badge bg-secondary me-1">${role}</span>`
                        ).join('');

                        const row = `
                            <tr>
                                <td>${user.id}</td>
                                <td>${user.username}</td>
                                <td>${user.age}</td>
                                <td>${roles}</td>
                                <td>
                                    <button type="button" class="btn btn-success edit-btn"
                                            data-id="${user.id}"
                                            data-username="${user.username}"
                                            data-age="${user.age}"
                                            data-roles='${JSON.stringify(user.roles)}'>
                                        Изменить
                                    </button>
                                </td>
                                <td>
                                    <button type="button" class="btn btn-danger delete-btn"
                                            data-id="${user.id}"
                                            data-username="${user.username}"
                                            data-age="${user.age}"
                                            data-roles='${JSON.stringify(user.roles)}'>
                                        Удалить
                                    </button>
                                </td>
                            </tr>
                        `;
                        tableBody.append(row);
                    });


                    $('.edit-btn').on('click', function () {
                        const userId = $(this).data('id');
                        const username = $(this).data('username');
                        const age = $(this).data('age');
                        const roles = $(this).data('roles');

                        $('#editId').val(userId);
                        $('#editFirstName').val(username);
                        $('#editAge').val(age);


                        $('#editRolesSelect').val(roles);

                        editModal.show();
                    });

                    $('.delete-btn').on('click', function () {
                        const userId = $(this).data('id');
                        const username = $(this).data('username');
                        const age = $(this).data('age');
                        const roles = $(this).data('roles');

                        $('#deleteUserId').text(userId);
                        $('#deleteUserName').text(username);
                        $('#deleteUserAge').text(age);
                        $('#deleteUserRoles').text(roles.join(', '));

                        $('#confirmDelete').data('id', userId);
                        deleteModal.show();
                    });
                })
                .catch(error => console.error('Error loading users:', error));
        }

        function addUser() {

            const selectedRoles = [];
            $('#rolesSelect option:selected').each(function () {
                selectedRoles.push(parseInt($(this).val())); // Преобразуем в число
            });

            if (selectedRoles.length === 0) {
                alert('Пожалуйста, выберите хотя бы одну роль!');
                return;
            }

            const formData = {
                username: $('#firstName').val(),
                age: $('#age').val(),
                password: $('#password').val(),
                roles: selectedRoles
            };

            fetch('/api/admins/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
                .then(response => {
                    if (!response.ok) throw new Error('Error adding user');
                    return response.json();
                })
                .then(() => {
                    $('#addUserForm')[0].reset();
                    loadUsers();

                    $('#user-table-tab').tab('show');
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error adding user: ' + error.message);
                });
        }


        function updateUser() {

            const selectedRoles = [];
            $('#editRolesSelect option:selected').each(function () {
                selectedRoles.push(parseInt($(this).val()));
            });

            const formData = {
                id: $('#editId').val(),
                username: $('#editFirstName').val(),
                age: $('#editAge').val(),
                password: $('#editPassword').val(),
                roles: selectedRoles
            };

            fetch('/api/admins/', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            })
                .then(response => {
                    if (!response.ok) throw new Error('Error updating user');
                    return response.json();
                })
                .then(() => {
                    editModal.hide();
                    loadUsers();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error updating user: ' + error.message);
                });
        }


        function deleteUser() {
            const userId = $('#confirmDelete').data('id');

            fetch(`/api/admins/${userId}`, {
                method: 'DELETE'
            })
                .then(response => {
                    if (!response.ok) throw new Error('Error deleting user');
                    deleteModal.hide();
                    loadUsers();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error deleting user: ' + error.message);
                });
        }
    });
</script>
</body>
</html>



